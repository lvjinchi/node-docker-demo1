name: Build and Push to AWS ECR (OIDC)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # 必须：允许GitHub Actions获取OIDC令牌
      contents: read   # 必须：允许拉取仓库代码

    steps:
      # 步骤1：拉取GitHub代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：通过OIDC获取AWS临时凭证（核心：无长期密钥）
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-ecr-session
          aws-region: ${{ secrets.AWS_REGION }}

      # 步骤3：自动登录AWS ECR
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # 步骤4：构建并推送镜像
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.AWS_ECR_REGISTRY }}:latest
            ${{ secrets.AWS_ECR_REGISTRY }}:${{ github.sha }}

      # 可选：登出ECR
      - name: Logout from Amazon ECR
        if: always()
        run: docker logout ${{ secrets.AWS_ECR_REGISTRY }}